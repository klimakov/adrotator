# Код-ревью AdRotator

## Сервер (Fastify + TypeScript)

### Исправлено в рамках ревью
- **track.ts:** убран `require('../db')`, используется импорт `queryOne` из `../db`.
- **track.ts:** добавлена валидация `creativeId` и `placementId` (400 при NaN).
- **admin/api.ts:** в `uploadImage()` добавлена проверка `res.ok` и выброс ошибки с текстом от API.

### Рекомендации
| Место | Рекомендация |
|-------|--------------|
| **serve.ts** (HTML) | `image_url` и `click_url` подставляются в HTML без экранирования. Для контента из админки риск ниже, но при возможности хранить произвольный URL стоит экранировать кавычки или валидировать URL. |
| **Роуты** | Параметры `id` в путях (`/campaigns/:id`) не валидируются на число — при нечисловом значении БД вернёт ошибку. Можно добавить общий хук или проверку и возвращать 400. |
| **Миграции** | При старте выполняется весь файл `001_initial.sql`; при добавлении новых миграций лучше нумеровать файлы и выполнять только недостающие (таблица `migrations` + проверка). |
| **Логирование** | В track ошибки пишутся в `console.error`; для единообразия лучше использовать `app.log` (пробросить в роуты или передать logger). |
| **CORS** | `origin: '*'` допустим для ad-server; для админки в продакшене лучше ограничить origin списком доменов. |

### Плюсы
- Чёткое разделение: config, db, redis, routes.
- Взвешенная ротация, кэш в Redis, флаш статистики в PG по таймеру.
- Использование параметризованных запросов (защита от SQL-инъекций).

---

## Админка (React + Vite)

### Рекомендации
| Место | Рекомендация |
|-------|--------------|
| **api.ts** | При 204 ответе возвращается `null as T` — для типизации можно ввести тип `EmptyResponse` и не использовать `any` в экспортируемых методах. |
| **Формы** | Ошибки сохранения не показываются пользователю (только в консоли). Имеет смысл показывать toast или блок с текстом ошибки. |
| **CampaignForm** | При ошибке загрузки кампании (getCampaign) форма остаётся пустой без сообщения — добавить обработку .catch и состояние ошибки. |
| **Удаление** | Используется `confirm()` — работает, но для единообразия можно модальное окно с кнопками «Отмена» / «Удалить». |

### Плюсы
- Единый слой API в `api.ts`, типы для ответов где заданы.
- Консистентные стили (Tailwind), доступность (aria-label, спиннер загрузки).

---

## SDK (ad.js)

### Рекомендации
| Место | Рекомендация |
|-------|--------------|
| **Ошибки** | Сетевые ошибки и не-200 ответы не логируются; для отладки можно опционально вызывать `console.warn` при отсутствии баннера. |
| **CORS** | Запрос к `/api/serve/:zone` с другого домена требует CORS на сервере — уже настроено. |

### Плюсы
- Лёгкий скрипт без зависимостей, авто-сканирование `[data-ad-zone]`, поддержка SPA через MutationObserver.

---

## Docker и деплой

### Рекомендации
| Место | Рекомендация |
|-------|--------------|
| **Секреты** | `POSTGRES_PASSWORD` из `.env`; в продакшене не коммитить `.env`, использовать секреты окружения. |
| **Миграции** | Сейчас миграции выполняются при старте сервера; при нескольких репликах возможен гонка. Вариант: отдельный job `docker compose run server npm run migrate` перед поднятием сервера. |
| **Логи** | Для прода лучше настроить драйвер логирования (json-file, объём). |

### Плюсы
- Healthcheck у postgres и redis, depends_on с condition: service_healthy.
- Nginx раздаёт SDK и проксирует API и админку.

---

## Итог
Критичных замечаний нет. Внесены правки: импорт в track, валидация id, обработка ошибки загрузки файла в админке. Остальное — улучшения на следующий спринт.

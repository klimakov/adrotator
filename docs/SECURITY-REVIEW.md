# Security Review — AdRotator

## Критичные риски

### 1. Открытый редирект (Open Redirect) — **ИСПРАВЛЕНО**

**Где:** `GET /track/click/:creativeId?redirect=...` — редирект на произвольный URL из query.

**Риск:** Злоумышленник подставляет ссылку на фишинговый сайт; пользователь думает, что перешёл по рекламе, и вводит данные.

**Рекомендация:** Разрешать редирект только на `http`/`https`, запрещать `javascript:`, `data:`, внутренние IP и localhost (или проверять, что URL из белого списка доменов кампании). Реализовано: валидация протокола и хоста (блокировка private/local).

---

### 2. SSRF через Webhook — **ИСПРАВЛЕНО**

**Где:** При клике отправляется POST на `campaign.webhook_url`.

**Риск:** В админке можно указать `http://169.254.169.254/` (metadata), `http://localhost:6379/`, `http://postgres:5432/` и т.д. Сервер делает запрос во внутреннюю сеть; возможна разведка и обход firewall.

**Рекомендация:** Перед запросом проверять, что хост не private IP (RFC 1918, 169.254.x.x, localhost). Реализовано: блокировка при вызове fetch.

---

### 3. Аутентификация на API админки — **РЕАЛИЗОВАНО (опционально)**

**Где:** Роуты `/campaigns`, `/creatives`, `/placements`, `/stats/*`.

**Реализация:** Если в окружении задан `API_KEY`, все запросы к этим путям должны содержать заголовок `X-API-Key: <API_KEY>`. Иначе 401. Публичные маршруты `/health`, `/serve/*`, `/track/*`, `/uploads/*` не проверяются. В админке при сборке можно задать `VITE_API_KEY` — тогда все запросы к API будут отправляться с этим заголовком.

---

## Высокий приоритет

### 4. Загрузка файлов (upload) — **ИСПРАВЛЕНО**

**Где:** `POST /creatives/upload` — расширение берётся из имени файла (`path.extname(data.filename)`).

**Риск:** Загрузка `shell.php` или `file.exe`; при раздаче через nginx или неправильной конфигурации возможна выполнение или обход фильтров. Path traversal, если в имени есть `../`.

**Рекомендация:** Разрешать только расширения изображений (`.png`, `.jpg`, `.jpeg`, `.gif`, `.webp`). Имя файла не использовать из запроса — сохранять как `uuid + ext`. Реализовано: allowlist расширений, имя только uuid + ext.

---

### 5. XSS в HTML-баннере и в serve — **ЧАСТИЧНО**

**Где:**  
- SDK: `wrapper.innerHTML = ad.html_content` — произвольный HTML из админки выполняется в контексте сайта паблишера.  
- Serve HTML: подстановка `creative.image_url`, `creative.click_url` в атрибуты.

**Реализация:** В ответе `/serve/:zoneKey/html` значение `image_url` при подстановке в атрибут `src` экранируется через `escapeHtmlAttr()` (&, ", ', <, >). Редирект в ссылке передаётся через `encodeURIComponent`.  
**Остаётся:** `html_content` по-прежнему вставляется как сырой HTML; при доверенной админке риск ниже, при мультитенанте — выводить в sandbox iframe или санитизировать (DOMPurify).

---

### 6. DoS: массовое присвоение креативов площадке — **ИСПРАВЛЕНО**

**Где:** `POST /placements/:id/creatives` с телом `{ creative_ids: number[] }`.

**Риск:** Передача массива из десятков тысяч id — множество INSERT и нагрузка на БД.

**Рекомендация:** Ограничить длину массива (например, до 500). Реализовано: лимит 500.

---

## Средний приоритет

### 7. Rate limiting — **РЕАЛИЗОВАНО**

**Где:** Все эндпоинты.

**Риск:** Флуд запросов к `/serve`, `/track/*`, админ-API — исчерпание ресурсов или Redis/БД.

**Реализация:** Подключён `@fastify/rate-limit`: 300 запросов в минуту на IP (по умолчанию). В продакшене при нескольких репликах можно перейти на Redis store.

---

### 8. Валидация и санитизация входных данных

**Где:** Тела запросов (campaign, creative, placement).

**Риск:** Слишком длинные строки (name, webhook_url), отрицательные числа (weight, frequency_cap) — переполнение или ошибки.

**Рекомендация:** Схемы валидации (JSON Schema / Zod): максимальная длина полей, тип и диапазон чисел, формат URL для webhook_url.

---

### 9. Секреты и конфигурация

**Где:** `.env`, `DATABASE_URL`, `POSTGRES_PASSWORD` в docker-compose.

**Рекомендация:** Не коммитить `.env`. В продакшене использовать секреты окружения или vault. Для БД — отдельный пользователь с минимальными правами (не суперпользователь).

---

## Низкий приоритет

### 10. CORS `*`

Для ad-server раздача баннеров на сторонние сайты обычно требует `Access-Control-Allow-Origin: *`. Для эндпоинтов админки (`/campaigns`, `/creatives` и т.д.) в продакшене лучше ограничить origin списком доменов админки.

### 11. Логирование

Не логировать в открытый доступ тела запросов с потенциально чувствительными данными (пароли, токены). Ошибки и метрики — без полного request body.

---

## Итог

- **Исправлено в коде:** открытый редирект (валидация URL), SSRF webhook (блокировка внутренних хостов), загрузка файлов (allowlist расширений, безопасное имя), лимит на размер массива `creative_ids`.
- **Требует доработки:** аутентификация на админ-API, rate limiting, жёсткая валидация входных данных, изоляция/санитизация HTML-креативов и URL в serve.

После исправлений перезапустить сервер и прогнать тесты.
